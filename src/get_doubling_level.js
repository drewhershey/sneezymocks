const { max, floor, sqrt } = Math;

// Results of running get_doubling_level on every level from
// 1 - 50
const DOUBLING_LEVELS = {
  1: 0.3900000000000002,
  2: 0.7300000000000004,
  3: 1.0300000000000007,
  4: 1.300000000000001,
  5: 1.5400000000000011,
  6: 1.7600000000000013,
  7: 1.9700000000000015,
  8: 2.149999999999998,
  9: 2.3199999999999945,
  10: 2.479999999999991,
  11: 2.629999999999988,
  12: 2.759999999999985,
  13: 2.8899999999999824,
  14: 3.00999999999998,
  15: 3.1199999999999775,
  16: 3.2199999999999753,
  17: 3.319999999999973,
  18: 3.419999999999971,
  19: 3.4999999999999694,
  20: 3.5899999999999674,
  21: 3.659999999999966,
  22: 3.7399999999999642,
  23: 3.8099999999999627,
  24: 3.8799999999999613,
  25: 3.93999999999996,
  26: 3.9999999999999587,
  27: 4.059999999999958,
  28: 4.119999999999957,
  29: 4.1699999999999555,
  30: 4.2199999999999545,
  31: 4.269999999999953,
  32: 4.319999999999952,
  33: 4.369999999999951,
  34: 4.40999999999995,
  35: 4.4499999999999496,
  36: 4.489999999999949,
  37: 4.529999999999948,
  38: 4.569999999999947,
  39: 4.609999999999946,
  40: 4.6399999999999455,
  41: 4.679999999999945,
  42: 4.709999999999944,
  43: 4.739999999999943,
  44: 4.769999999999943,
  45: 4.799999999999942,
  46: 4.8299999999999415,
  47: 4.859999999999941,
  48: 4.88999999999994,
  49: 4.90999999999994,
  50: 4.939999999999939,
};

function getDoublingLevel(realLevel) {
  const RESOLUTION = 0.01;
  const mobDoubleTable = new Map();

  for (let k = 0; ; k += RESOLUTION) {
    const perc = (0.6 - k * 0.03) / (0.6 + k * 0.03);
    const lbla = sqrt(2 * perc) - 1;
    const lookupLev = floor(k / lbla / RESOLUTION);
    mobDoubleTable.set(lookupLev, k);
    if (floor(lookupLev * RESOLUTION) >= 50) break;
  }

  let levelToFind = floor(max(realLevel, 1) / RESOLUTION);
  let kLev = 0;
  while (kLev === 0) {
    if (mobDoubleTable.has(levelToFind)) {
      kLev = mobDoubleTable.get(levelToFind);
    } else {
      levelToFind -= 1;
    }
  }
  return kLev <= 0 ? 1 : kLev;
}

module.exports = { DOUBLING_LEVELS, getDoublingLevel };
